"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[7469],{5727:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>i,contentTitle:()=>r,default:()=>u,frontMatter:()=>o,metadata:()=>c,toc:()=>l});var s=t(4848),a=t(8453);const o={},r="Extra Features",c={id:"documentation/extras",title:"Extra Features",description:"Named placeholders",source:"@site/docs/documentation/extras.mdx",sourceDirName:"documentation",slug:"/documentation/extras",permalink:"/node-mysql2/zh-CN/docs/documentation/extras",draft:!1,unlisted:!1,editUrl:"https://github.com/sidorares/node-mysql2/tree/master/website/docs/documentation/extras.mdx",tags:[],version:"current",frontMatter:{},sidebar:"docs",previous:{title:"Authentication Switch Request",permalink:"/node-mysql2/zh-CN/docs/documentation/authentication-switch"},next:{title:"MySQL Server API",permalink:"/node-mysql2/zh-CN/docs/documentation/mysql-server"}},i={},l=[{value:"Named placeholders",id:"named-placeholders",level:2},{value:"Receiving rows as array of columns instead of hash with column name as key:",id:"receiving-rows-as-array-of-columns-instead-of-hash-with-column-name-as-key",level:2},{value:"Sending tabular data with &#39;load infile&#39; and local stream:",id:"sending-tabular-data-with-load-infile-and-local-stream",level:2},{value:"Connecting using custom stream:",id:"connecting-using-custom-stream",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",p:"p",pre:"pre",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"extra-features",children:"Extra Features"}),"\n",(0,s.jsx)(n.h2,{id:"named-placeholders",children:"Named placeholders"}),"\n",(0,s.jsxs)(n.p,{children:["You can use named placeholders for parameters by setting ",(0,s.jsx)(n.code,{children:"namedPlaceholders"})," config value or query/execute time option. Named placeholders are converted to unnamed ",(0,s.jsx)(n.code,{children:"?"})," on the client (mysql protocol does not support named parameters). If you reference parameter multiple times under the same name it is sent to server multiple times. Unnamed placeholders can still be used by providing the values as an array instead of an object."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:"connection.config.namedPlaceholders = true;\nconnection.execute('select :x + :y as z', { x: 1, y: 2 }, (err, rows) => {\n  // statement prepared as \"select ? + ? as z\" and executed with [1,2] values\n  // rows returned: [ { z: 3 } ]\n});\n\nconnection.execute('select :x + :x as z', { x: 1 }, (err, rows) => {\n  // select ? + ? as z, execute with [1, 1]\n});\n\nconnection.query('select :x + :x as z', { x: 1 }, (err, rows) => {\n  // query select 1 + 1 as z\n});\n\n// unnamed placeholders are still valid if the values are provided in an array\nconnection.query('select ? + ? as z', [1, 1], (err, rows) => {\n  // query select 1 + 1 as z\n});\n"})}),"\n",(0,s.jsx)(n.h2,{id:"receiving-rows-as-array-of-columns-instead-of-hash-with-column-name-as-key",children:"Receiving rows as array of columns instead of hash with column name as key:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:"const options = { sql: 'select A,B,C,D from foo', rowsAsArray: true };\nconnection.query(options, (err, results) => {\n  /* results will be an array of arrays like this now:\n  [[\n     'field A value',\n     'field B value',\n     'field C value',\n     'field D value',\n  ], ...]\n  */\n});\n"})}),"\n",(0,s.jsx)(n.h2,{id:"sending-tabular-data-with-load-infile-and-local-stream",children:"Sending tabular data with 'load infile' and local stream:"}),"\n",(0,s.jsxs)(n.p,{children:["In addition to sending local fs files you can send any stream using ",(0,s.jsx)(n.code,{children:"infileStreamFactory"})," query option. If set, it has to be a function that return a readable stream. It gets file path from query as a parameter."]}),"\n",(0,s.jsxs)(n.p,{children:["Note: starting from version 2.0 ",(0,s.jsx)(n.code,{children:"infileStreamFactory"})," is required parameter for ",(0,s.jsx)(n.code,{children:"LOAD DATA LOCAL INFILE"}),". Response from server indicates that it wants access to a local file and no ",(0,s.jsx)(n.code,{children:"infileStreamFactory"})," option is provided the query ends with error."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:"// local file\nconnection.query(\n  'LOAD DATA LOCAL INFILE \"/tmp/data.csv\" INTO TABLE test FIELDS TERMINATED BY ? (id, title)',\n  onInserted1\n);\n// local stream\nconst sql =\n  'LOAD DATA LOCAL INFILE \"mystream\" INTO TABLE test FIELDS TERMINATED BY ? (id, title)';\nconnection.query(\n  {\n    sql: sql,\n    infileStreamFactory: function (path) {\n      return getStream();\n    },\n  },\n  onInserted2\n);\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"infileStreamFactory"})," option may also be set at a connection-level:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:"const fs = require('fs');\nconst mysql = require('mysql2');\n\nconst connection = mysql.createConnection({\n  user: 'test',\n  database: 'test',\n  infileStreamFactory: (path) => {\n    // Validate file path\n    const validPaths = ['/tmp/data.csv'];\n    if (!validPaths.includes(path)) {\n      throw new Error(\n        `invalid file path: ${path}: expected to be one of ${validPaths.join(\n          ','\n        )}`\n      );\n    }\n    return fs.createReadStream(path);\n  },\n});\n\nconnection.query(\n  'LOAD DATA LOCAL INFILE \"/tmp/data.csv\" INTO TABLE test',\n  onInserted\n);\n"})}),"\n",(0,s.jsx)(n.h2,{id:"connecting-using-custom-stream",children:"Connecting using custom stream:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:"const net = require('net');\nconst mysql = require('mysql2');\nconst shape = require('shaper');\nconst connection = mysql.createConnection({\n  user: 'test',\n  database: 'test',\n  stream: net.connect('/tmp/mysql.sock').pipe(shape(10)), // emulate 10 bytes/sec link\n});\nconnection.query('SELECT 1+1 as test1', console.log);\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"stream"})," also can be a function. In that case function result has to be duplex stream, and it is used for connection transport. This is required if you connect pool using custom transport as new pooled connection needs new stream. ",(0,s.jsx)(n.a,{href:"https://github.com/sidorares/node-mysql2/issues/80",children:"Example"})," connecting over socks5 proxy:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:"const mysql = require('mysql2');\nconst SocksConnection = require('socksjs');\nconst pool = mysql.createPool({\n  database: 'test',\n  user: 'foo',\n  password: 'bar',\n  stream: function (cb) {\n    const newStream = new SocksConnection(\n      { host: 'remote.host', port: 3306 },\n      { host: 'localhost', port: 1080 }\n    );\n    cb(null, newStream);\n  },\n});\n"})}),"\n",(0,s.jsxs)(n.p,{children:["In addition to password ",(0,s.jsx)(n.code,{children:"createConnection()"}),", ",(0,s.jsx)(n.code,{children:"createPool()"})," and ",(0,s.jsx)(n.code,{children:"changeUser()"})," accept ",(0,s.jsx)(n.code,{children:"passwordSha1"})," option. This is useful when implementing proxies as plaintext password might be not available."]})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>c});var s=t(6540);const a={},o=s.createContext(a);function r(e){const n=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);